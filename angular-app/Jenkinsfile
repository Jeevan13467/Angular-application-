pipeline {
    agent any

    tools {
        nodejs 'NodeJS'
    }

    environment {
        APP_NAME = 'my-app'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git 'https://github.com/Jeevan13467/Angular-application-.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }

        stage('Build Angular App') {
            steps {
                sh 'ng build --configuration production'
            }
        }

        stage('Replace Files in Pod') {
            steps {
                script {
                    // Get the pod name dynamically
                    def POD_NAME = sh(
                        script: "kubectl get pod -l app=$Angular-application- -o jsonpath='{.items[0].metadata.name}'",
                        returnStdout: true
                    ).trim()

                    echo "Found pod: ${POD_NAME}"

                    // Copy build files to pod (assumes nginx is serving /usr/share/nginx/html)
                    sh "kubectl exec ${POD_NAME} -- rm -rf /usr/share/nginx/html/*"
                    sh "kubectl cp dist/angular-app/. ${POD_NAME}:/usr/share/nginx/html/"
                }
            }
        }
    }

    post {
        success {
            echo '✅ App rebuilt and deployed!'
        }
        failure {
            echo '❌ Deployment failed.'
        }
    }
}
